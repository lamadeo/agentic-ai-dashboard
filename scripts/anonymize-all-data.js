#!/usr/bin/env node

/**
 * Comprehensive Data Anonymization Script
 *
 * Applies employee mapping to ALL data files, replacing:
 * - Email addresses (real@techco.com ‚Üí fictional@techco.com)
 * - Employee names (Real Person ‚Üí Fictional Person)
 * - Company references (TechCo Inc ‚Üí TechCo Inc)
 *
 * Usage: node scripts/anonymize-all-data.js
 * Requires: scripts/employee-mapping.json (generated by generate-employee-mapping.js)
 */

const fs = require('fs');
const path = require('path');

// Load employee mapping
const MAPPING_FILE = path.join(__dirname, 'employee-mapping.json');
if (!fs.existsSync(MAPPING_FILE)) {
  console.error('‚ùå Error: employee-mapping.json not found');
  console.error('   Run: node scripts/generate-employee-mapping.js first');
  process.exit(1);
}

const employeeMapping = JSON.parse(fs.readFileSync(MAPPING_FILE, 'utf8'));
console.log(`üìñ Loaded mappings for ${Object.keys(employeeMapping).length} employees\n`);

// Statistics
const stats = {
  filesProcessed: 0,
  filesModified: 0,
  emailReplacements: 0,
  nameReplacements: 0,
  companyReplacements: 0,
  errors: 0
};

/**
 * Recursively walk directory for files
 */
function* walkDirectory(dir, skipDirs = ['node_modules', '.git', '.next', 'dist', 'build']) {
  const files = fs.readdirSync(dir, { withFileTypes: true });
  for (const file of files) {
    const fullPath = path.join(dir, file.name);
    if (file.isDirectory()) {
      if (!skipDirs.includes(file.name)) {
        yield* walkDirectory(fullPath, skipDirs);
      }
    } else {
      yield fullPath;
    }
  }
}

/**
 * Replace all occurrences in content
 */
function replaceAll(content, searchValue, replaceValue) {
  let count = 0;
  const regex = new RegExp(escapeRegExp(searchValue), 'g');
  const newContent = content.replace(regex, () => {
    count++;
    return replaceValue;
  });
  return { newContent, count };
}

/**
 * Escape special regex characters
 */
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Anonymize content in a file
 */
function anonymizeContent(content, filePath) {
  let modified = false;
  let result = content;
  let fileEmailReplacements = 0;
  let fileNameReplacements = 0;
  let fileCompanyReplacements = 0;

  // Replace emails and associated names
  for (const [realEmail, fictional] of Object.entries(employeeMapping)) {
    // Replace email addresses
    const emailResult = replaceAll(result, realEmail, fictional.email);
    result = emailResult.newContent;
    if (emailResult.count > 0) {
      fileEmailReplacements += emailResult.count;
      modified = true;
    }

    // Replace full names (case-sensitive)
    // Extract real name from email if we don't have it
    const realName = realEmail.split('@')[0].split('.').map(s =>
      s.charAt(0).toUpperCase() + s.slice(1)
    ).join(' ');

    const nameResult = replaceAll(result, realName, fictional.name);
    result = nameResult.newContent;
    if (nameResult.count > 0) {
      fileNameReplacements += nameResult.count;
      modified = true;
    }
  }

  // Replace company references
  const companyReplacements = [
    { from: 'TechCo Inc', to: 'TechCo Inc' },
    { from: 'TechCo Inc', to: 'TechCo Inc' },
    { from: 'techco', to: 'techco' },
    { from: 'TECHCO', to: 'TECHCO' },
    { from: '@techco.com', to: '@techco.com' }, // Catch any remaining
  ];

  for (const replacement of companyReplacements) {
    const companyResult = replaceAll(result, replacement.from, replacement.to);
    result = companyResult.newContent;
    if (companyResult.count > 0) {
      fileCompanyReplacements += companyResult.count;
      modified = true;
    }
  }

  // Update statistics
  stats.emailReplacements += fileEmailReplacements;
  stats.nameReplacements += fileNameReplacements;
  stats.companyReplacements += fileCompanyReplacements;

  if (modified) {
    stats.filesModified++;
  }

  return { content: result, modified };
}

/**
 * Process a single file
 */
function processFile(filePath) {
  try {
    stats.filesProcessed++;

    // Check file size - skip files over 50MB to avoid memory issues
    const fileStats = fs.statSync(filePath);
    const fileSizeMB = fileStats.size / (1024 * 1024);

    if (fileSizeMB > 50) {
      console.log(`\n‚è≠Ô∏è  Skipping large file (${fileSizeMB.toFixed(1)}MB): ${path.basename(filePath)}`);
      return false;
    }

    // Read file
    const content = fs.readFileSync(filePath, 'utf8');

    // Anonymize content
    const { content: newContent, modified } = anonymizeContent(content, filePath);

    // Write back if modified
    if (modified) {
      fs.writeFileSync(filePath, newContent, 'utf8');
      return true;
    }

    return false;
  } catch (error) {
    console.error(`\n‚ùå Error processing ${filePath}: ${error.message}`);
    stats.errors++;
    return false;
  }
}

/**
 * Rename files with techco in the name
 */
function renameFile(filePath) {
  const dir = path.dirname(filePath);
  const filename = path.basename(filePath);

  if (filename.toLowerCase().includes('techco')) {
    const newFilename = filename
      .replace(/TechCo Inc/g, 'TechCo')
      .replace(/TechCo Inc/g, 'TechCo')
      .replace(/techco/g, 'techco');

    const newPath = path.join(dir, newFilename);

    fs.renameSync(filePath, newPath);
    console.log(`   üìù Renamed: ${filename} ‚Üí ${newFilename}`);
    return newPath;
  }

  return filePath;
}

/**
 * Main anonymization function
 */
async function anonymizeAllData() {
  console.log('üé≠ Starting comprehensive data anonymization...\n');

  const dataDir = path.join(__dirname, '..', 'data');

  // Process all files
  console.log('üìÅ Processing data files...\n');

  const filesToRename = [];

  for (const filePath of walkDirectory(dataDir)) {
    const ext = path.extname(filePath).toLowerCase();

    // Process JSON, CSV, and MD files
    if (['.json', '.csv', '.md', '.txt'].includes(ext)) {
      const modified = processFile(filePath);

      // Track files for renaming
      if (path.basename(filePath).toLowerCase().includes('techco')) {
        filesToRename.push(filePath);
      }

      // Show progress
      if (stats.filesProcessed % 10 === 0) {
        process.stdout.write(`\r   Processed ${stats.filesProcessed} files...`);
      }
    }
  }

  console.log(`\r   Processed ${stats.filesProcessed} files ‚úì\n`);

  // Rename files with techco in the name
  if (filesToRename.length > 0) {
    console.log(`\nüìù Renaming ${filesToRename.length} files...\n`);
    for (const filePath of filesToRename) {
      renameFile(filePath);
    }
  }

  // Print statistics
  console.log(`\n‚úÖ Anonymization complete!\n`);
  console.log(`üìä Statistics:`);
  console.log(`   - Files processed: ${stats.filesProcessed}`);
  console.log(`   - Files modified: ${stats.filesModified}`);
  console.log(`   - Email replacements: ${stats.emailReplacements}`);
  console.log(`   - Name replacements: ${stats.nameReplacements}`);
  console.log(`   - Company replacements: ${stats.companyReplacements}`);
  console.log(`   - Errors: ${stats.errors}`);

  console.log(`\nüßπ Next steps:`);
  console.log(`   1. Review modified files to verify anonymization`);
  console.log(`   2. Delete scripts/employee-mapping.json (contains real emails)`);
  console.log(`   3. Continue with Phase 3: Code Updates\n`);
}

// Run the anonymization
anonymizeAllData().catch(error => {
  console.error('‚ùå Fatal error:', error);
  process.exit(1);
});
